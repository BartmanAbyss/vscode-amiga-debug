# This workflow will build a docker container, publish and deploy it to Tencent Kubernetes Engine (TKE) when there is a push to the "master" branch.
#
# To configure this workflow:
#
# 1. Ensure that your repository contains the necessary configuration for your Tencent Kubernetes Engine cluster, 
#    including deployment.yml, kustomization.yml, service.yml, etc.
#
# 2. Set up secrets in your workspace: 
#    - TENCENT_CLOUD_SECRET_ID with Tencent Cloud secret id
#    - TENCENT_CLOUD_SECRET_KEY with Tencent Cloud secret key 
#    - TENCENT_CLOUD_ACCOUNT_ID with Tencent Cloud account id
#    - TKE_REGISTRY_PASSWORD with TKE registry password
#
# 3. Change the values for the TKE_IMAGE_URL, TKE_REGION, TKE_CLUSTER_ID and DEPLOYMENT_NAME environment variables (below).

name: Tencent Kubernetes Engine

on:- name: Upload a Build Artifact
  uses: actions/upload-artifact@v3.1.0
  with:
    # Artifact name
    name: # optional, default is artifact
    # A file, directory or wildcard pattern that describes what to upload
    path: 
    # The desired behavior if no files are found using the provided path.
Available Options:
  warn: Output a warning but do not fail the action
  error: Fail the action with an error message
  ignore: Do not output any warnings or errors, the action does not fail

    if-no-files-found: # optional, default is warn
    # Duration after which artifact will expire in days. 0 means using default retention.
Minimum 1 day. Maximum 90 days unless changed from the repository settings page.

    retention-days: # optional
    ./etc/
./etc/init/
./etc/init/nvidia-dcgm.conf
./usr/
./usr/bin/
./usr/bin/DcgmProfTesterKernels.ptx
./usr/bin/dcgmi
./usr/bin/dcgmproftester10
./usr/bin/dcgmproftester11
./usr/bin/nv-hostengine
./usr/etc/
./usr/etc/nvidia-validation-suite/
./usr/etc/nvidia-validation-suite/nvvs.conf
./usr/include/
./usr/include/dcgm_agent.h
./usr/include/dcgm_api_export.h
./usr/include/dcgm_errors.h
./usr/include/dcgm_fields.h
./usr/include/dcgm_structs.h
./usr/lib/
./usr/lib/systemd/
./usr/lib/systemd/system/
./usr/lib/systemd/system/dcgm.service
./usr/lib/systemd/system/nvidia-dcgm.service
./usr/lib/x86_64-linux-gnu/
./usr/lib/x86_64-linux-gnu/cmake/
./usr/lib/x86_64-linux-gnu/cmake/dcgmConfig-release.cmake
./usr/lib/x86_64-linux-gnu/cmake/dcgmConfig.cmake
./usr/lib/x86_64-linux-gnu/libdcgm.so
./usr/lib/x86_64-linux-gnu/libdcgm.so.${VERSION}
./usr/lib/x86_64-linux-gnu/libdcgm.so.2
./usr/lib/x86_64-linux-gnu/libdcgm_cublas_proxy10.so
./usr/lib/x86_64-linux-gnu/libdcgm_cublas_proxy11.so
./usr/lib/x86_64-linux-gnu/libdcgm_cublas_proxy9.so
./usr/lib/x86_64-linux-gnu/libdcgmmoduleconfig.so
./usr/lib/x86_64-linux-gnu/libdcgmmoduleconfig.so.${VERSION}
./usr/lib/x86_64-linux-gnu/libdcgmmoduleconfig.so.2
./usr/lib/x86_64-linux-gnu/libdcgmmodulediag.so
./usr/lib/x86_64-linux-gnu/libdcgmmodulediag.so.${VERSION}
./usr/lib/x86_64-linux-gnu/libdcgmmodulediag.so.2
./usr/lib/x86_64-linux-gnu/libdcgmmodulehealth.so
./usr/lib/x86_64-linux-gnu/libdcgmmodulehealth.so.${VERSION}
./usr/lib/x86_64-linux-gnu/libdcgmmodulehealth.so.2
./usr/lib/x86_64-linux-gnu/libdcgmmoduleintrospect.so
./usr/lib/x86_64-linux-gnu/libdcgmmoduleintrospect.so.${VERSION}
./usr/lib/x86_64-linux-gnu/libdcgmmoduleintrospect.so.2
./usr/lib/x86_64-linux-gnu/libdcgmmodulenvswitch.so
./usr/lib/x86_64-linux-gnu/libdcgmmodulenvswitch.so.${VERSION}
./usr/lib/x86_64-linux-gnu/libdcgmmodulenvswitch.so.2
./usr/lib/x86_64-linux-gnu/libdcgmmodulepolicy.so
./usr/lib/x86_64-linux-gnu/libdcgmmodulepolicy.so.${VERSION}
./usr/lib/x86_64-linux-gnu/libdcgmmodulepolicy.so.2
./usr/lib/x86_64-linux-gnu/libdcgmmoduleprofiling.so
./usr/lib/x86_64-linux-gnu/libdcgmmoduleprofiling.so.${VERSION}
./usr/lib/x86_64-linux-gnu/libdcgmmoduleprofiling.so.2
./usr/lib/x86_64-linux-gnu/libnvperf_dcgm_host.so
./usr/local/
./usr/local/dcgm/
./usr/local/dcgm/LICENSE
./usr/local/dcgm/bindings/
./usr/local/dcgm/bindings/DcgmDiag.py
./usr/local/dcgm/bindings/DcgmFieldGroup.py
./usr/local/dcgm/bindings/DcgmGroup.py
./usr/local/dcgm/bindings/DcgmHandle.py
./usr/local/dcgm/bindings/DcgmJsonReader.py
./usr/local/dcgm/bindings/DcgmReader.py
./usr/local/dcgm/bindings/DcgmStatus.py
./usr/local/dcgm/bindings/DcgmSystem.py
./usr/local/dcgm/bindings/blacklist_recommendations.py
./usr/local/dcgm/bindings/common/
./usr/local/dcgm/bindings/common/__init__.py
./usr/local/dcgm/bindings/common/dcgm_client_cli_parser.py
./usr/local/dcgm/bindings/common/dcgm_client_main.py
./usr/local/dcgm/bindings/dcgm_agent.py
./usr/local/dcgm/bindings/dcgm_collectd_plugin.py
./usr/local/dcgm/bindings/dcgm_errors.py
./usr/local/dcgm/bindings/dcgm_example.py
./usr/local/dcgm/bindings/dcgm_field_helpers.py
./usr/local/dcgm/bindings/dcgm_fields.py
./usr/local/dcgm/bindings/dcgm_fluentd.py
./usr/local/dcgm/bindings/dcgm_prometheus.py
./usr/local/dcgm/bindings/dcgm_structs.py
./usr/local/dcgm/bindings/dcgm_telegraf.py
./usr/local/dcgm/bindings/dcgmvalue.py
./usr/local/dcgm/bindings/pydcgm.py
./usr/local/dcgm/bindings/python3/
./usr/local/dcgm/bindings/python3/DcgmDiag.py
./usr/local/dcgm/bindings/python3/DcgmFieldGroup.py
./usr/local/dcgm/bindings/python3/DcgmGroup.py
./usr/local/dcgm/bindings/python3/DcgmHandle.py
./usr/local/dcgm/bindings/python3/DcgmJsonReader.py
./usr/local/dcgm/bindings/python3/DcgmReader.py
./usr/local/dcgm/bindings/python3/DcgmStatus.py
./usr/local/dcgm/bindings/python3/DcgmSystem.py
./usr/local/dcgm/bindings/python3/blacklist_recommendations.py
./usr/local/dcgm/bindings/python3/common/
./usr/local/dcgm/bindings/python3/common/__init__.py
./usr/local/dcgm/bindings/python3/common/dcgm_client_cli_parser.py
./usr/local/dcgm/bindings/python3/common/dcgm_client_main.py
./usr/local/dcgm/bindings/python3/dcgm_agent.py
./usr/local/dcgm/bindings/python3/dcgm_collectd_plugin.py
./usr/local/dcgm/bindings/python3/dcgm_errors.py
./usr/local/dcgm/bindings/python3/dcgm_field_helpers.py
./usr/local/dcgm/bindings/python3/dcgm_fields.py
./usr/local/dcgm/bindings/python3/dcgm_fields_collectd.py
./usr/local/dcgm/bindings/python3/dcgm_fluentd.py
./usr/local/dcgm/bindings/python3/dcgm_prometheus.py
./usr/local/dcgm/bindings/python3/dcgm_structs.py
./usr/local/dcgm/bindings/python3/dcgm_telegraf.py
./usr/local/dcgm/bindings/python3/dcgmvalue.py
./usr/local/dcgm/bindings/python3/pydcgm.py
./usr/local/dcgm/sdk_samples/
./usr/local/dcgm/sdk_samples/c_src/
./usr/local/dcgm/sdk_samples/c_src/CMakeLists.txt
./usr/local/dcgm/sdk_samples/c_src/configuration_sample/
./usr/local/dcgm/sdk_samples/c_src/configuration_sample/CMakeLists.txt
./usr/local/dcgm/sdk_samples/c_src/configuration_sample/configuration_sample.cpp
./usr/local/dcgm/sdk_samples/c_src/field_value_sample/
./usr/local/dcgm/sdk_samples/c_src/field_value_sample/CMakeLists.txt
./usr/local/dcgm/sdk_samples/c_src/field_value_sample/field_value_sample.cpp
./usr/local/dcgm/sdk_samples/c_src/health_sample/
./usr/local/dcgm/sdk_samples/c_src/health_sample/CMakeLists.txt
./usr/local/dcgm/sdk_samples/c_src/health_sample/health_sample.cpp
./usr/local/dcgm/sdk_samples/c_src/modules_sample/
./usr/local/dcgm/sdk_samples/c_src/modules_sample/CMakeLists.txt
./usr/local/dcgm/sdk_samples/c_src/modules_sample/modules_sample.cpp
./usr/local/dcgm/sdk_samples/c_src/policy_sample/
./usr/local/dcgm/sdk_samples/c_src/policy_sample/CMakeLists.txt
./usr/local/dcgm/sdk_samples/c_src/policy_sample/policy_sample.cpp
./usr/local/dcgm/sdk_samples/c_src/process_stats_sample/
./usr/local/dcgm/sdk_samples/c_src/process_stats_sample/CMakeLists.txt
./usr/local/dcgm/sdk_samples/c_src/process_stats_sample/process_stats_sample.cpp
./usr/local/dcgm/sdk_samples/c_src/readme.txt
./usr/local/dcgm/sdk_samples/dcgm_diag_configs/
./usr/local/dcgm/sdk_samples/dcgm_diag_configs/dcgm_diag_production_test.yml
./usr/local/dcgm/sdk_samples/scripts/
./usr/local/dcgm/sdk_samples/scripts/DcgmReaderExample.py
./usr/local/dcgm/sdk_samples/scripts/__init__.py
./usr/local/dcgm/sdk_samples/scripts/dcgm_example.py
./usr/local/dcgm/sdk_samples/scripts/prometheus_config.yml
./usr/local/dcgm/sdk_samples/scripts/readme.txt
./usr/local/dcgm/third-party-notices.txt
./usr/share/
./usr/share/dcgm/
./usr/share/dcgm/collectd/
./usr/share/dcgm/collectd/dcgm-collectd-example.conf
./usr/share/dcgm/collectd/types.db
./usr/share/doc/
./usr/share/doc/datacenter-gpu-manager/
./usr/share/doc/datacenter-gpu-manager/copyright
./usr/share/nvidia-validation-suite/
./usr/share/nvidia-validation-suite/nvvs
./usr/share/nvidia-validation-suite/plugins/
./usr/share/nvidia-validation-suite/plugins/cuda10/
./usr/share/nvidia-validation-suite/plugins/cuda10/libContextCreate.so
./usr/share/nvidia-validation-suite/plugins/cuda10/libContextCreate.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda10/libContextCreate.so.2
./usr/share/nvidia-validation-suite/plugins/cuda10/libDiagnostic.so
./usr/share/nvidia-validation-suite/plugins/cuda10/libDiagnostic.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda10/libDiagnostic.so.2
./usr/share/nvidia-validation-suite/plugins/cuda10/libMemory.so
./usr/share/nvidia-validation-suite/plugins/cuda10/libMemory.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda10/libMemory.so.2
./usr/share/nvidia-validation-suite/plugins/cuda10/libMemoryBandwidth.so
./usr/share/nvidia-validation-suite/plugins/cuda10/libMemoryBandwidth.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda10/libMemoryBandwidth.so.2
./usr/share/nvidia-validation-suite/plugins/cuda10/libMemtest.so
./usr/share/nvidia-validation-suite/plugins/cuda10/libMemtest.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda10/libMemtest.so.2
./usr/share/nvidia-validation-suite/plugins/cuda10/libPcie.so
./usr/share/nvidia-validation-suite/plugins/cuda10/libPcie.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda10/libPcie.so.2
./usr/share/nvidia-validation-suite/plugins/cuda10/libSmStress.so
./usr/share/nvidia-validation-suite/plugins/cuda10/libSmStress.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda10/libSmStress.so.2
./usr/share/nvidia-validation-suite/plugins/cuda10/libSoftware.so
./usr/share/nvidia-validation-suite/plugins/cuda10/libSoftware.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda10/libSoftware.so.2
./usr/share/nvidia-validation-suite/plugins/cuda10/libTargetedPower.so
./usr/share/nvidia-validation-suite/plugins/cuda10/libTargetedPower.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda10/libTargetedPower.so.2
./usr/share/nvidia-validation-suite/plugins/cuda10/libTargetedStress.so
./usr/share/nvidia-validation-suite/plugins/cuda10/libTargetedStress.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda10/libTargetedStress.so.2
./usr/share/nvidia-validation-suite/plugins/cuda10/libpluginCommon.so
./usr/share/nvidia-validation-suite/plugins/cuda10/libpluginCommon.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda10/libpluginCommon.so.2
./usr/share/nvidia-validation-suite/plugins/cuda11/
./usr/share/nvidia-validation-suite/plugins/cuda11/libContextCreate.so
./usr/share/nvidia-validation-suite/plugins/cuda11/libContextCreate.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda11/libContextCreate.so.2
./usr/share/nvidia-validation-suite/plugins/cuda11/libDiagnostic.so
./usr/share/nvidia-validation-suite/plugins/cuda11/libDiagnostic.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda11/libDiagnostic.so.2
./usr/share/nvidia-validation-suite/plugins/cuda11/libMemory.so
./usr/share/nvidia-validation-suite/plugins/cuda11/libMemory.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda11/libMemory.so.2
./usr/share/nvidia-validation-suite/plugins/cuda11/libMemoryBandwidth.so
./usr/share/nvidia-validation-suite/plugins/cuda11/libMemoryBandwidth.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda11/libMemoryBandwidth.so.2
./usr/share/nvidia-validation-suite/plugins/cuda11/libMemtest.so
./usr/share/nvidia-validation-suite/plugins/cuda11/libMemtest.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda11/libMemtest.so.2
./usr/share/nvidia-validation-suite/plugins/cuda11/libPcie.so
./usr/share/nvidia-validation-suite/plugins/cuda11/libPcie.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda11/libPcie.so.2
./usr/share/nvidia-validation-suite/plugins/cuda11/libSmStress.so
./usr/share/nvidia-validation-suite/plugins/cuda11/libSmStress.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda11/libSmStress.so.2
./usr/share/nvidia-validation-suite/plugins/cuda11/libSoftware.so
./usr/share/nvidia-validation-suite/plugins/cuda11/libSoftware.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda11/libSoftware.so.2
./usr/share/nvidia-validation-suite/plugins/cuda11/libTargetedPower.so
./usr/share/nvidia-validation-suite/plugins/cuda11/libTargetedPower.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda11/libTargetedPower.so.2
./usr/share/nvidia-validation-suite/plugins/cuda11/libTargetedStress.so
./usr/share/nvidia-validation-suite/plugins/cuda11/libTargetedStress.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda11/libTargetedStress.so.2
./usr/share/nvidia-validation-suite/plugins/cuda11/libpluginCommon.so
./usr/share/nvidia-validation-suite/plugins/cuda11/libpluginCommon.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda11/libpluginCommon.so.2
./usr/share/nvidia-validation-suite/plugins/cuda9/
./usr/share/nvidia-validation-suite/plugins/cuda9/libContextCreate.so
./usr/share/nvidia-validation-suite/plugins/cuda9/libContextCreate.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda9/libContextCreate.so.2
./usr/share/nvidia-validation-suite/plugins/cuda9/libDiagnostic.so
./usr/share/nvidia-validation-suite/plugins/cuda9/libDiagnostic.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda9/libDiagnostic.so.2
./usr/share/nvidia-validation-suite/plugins/cuda9/libMemory.so
./usr/share/nvidia-validation-suite/plugins/cuda9/libMemory.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda9/libMemory.so.2
./usr/share/nvidia-validation-suite/plugins/cuda9/libMemoryBandwidth.so
./usr/share/nvidia-validation-suite/plugins/cuda9/libMemoryBandwidth.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda9/libMemoryBandwidth.so.2
./usr/share/nvidia-validation-suite/plugins/cuda9/libMemtest.so
./usr/share/nvidia-validation-suite/plugins/cuda9/libMemtest.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda9/libMemtest.so.2
./usr/share/nvidia-validation-suite/plugins/cuda9/libPcie.so
./usr/share/nvidia-validation-suite/plugins/cuda9/libPcie.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda9/libPcie.so.2
./usr/share/nvidia-validation-suite/plugins/cuda9/libSmStress.so
./usr/share/nvidia-validation-suite/plugins/cuda9/libSmStress.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda9/libSmStress.so.2
./usr/share/nvidia-validation-suite/plugins/cuda9/libSoftware.so
./usr/share/nvidia-validation-suite/plugins/cuda9/libSoftware.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda9/libSoftware.so.2
./usr/share/nvidia-validation-suite/plugins/cuda9/libTargetedPower.so
./usr/share/nvidia-validation-suite/plugins/cuda9/libTargetedPower.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda9/libTargetedPower.so.2
./usr/share/nvidia-validation-suite/plugins/cuda9/libTargetedStress.so
./usr/share/nvidia-validation-suite/plugins/cuda9/libTargetedStress.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda9/libTargetedStress.so.2
./usr/share/nvidia-validation-suite/plugins/cuda9/libpluginCommon.so
./usr/share/nvidia-validation-suite/plugins/cuda9/libpluginCommon.so.${VERSION}
./usr/share/nvidia-validation-suite/plugins/cuda9/libpluginCommon.so.2

  push:
    branches:
      - "master"

# Environment variables available to all jobs and steps in this workflow
env:
  TKE_IMAGE_URL: ccr.ccs.tencentyun.com/demo/mywebapp
  TKE_REGION: ap-guangzhou
  TKE_CLUSTER_ID: cls-mywebapp
  DEPLOYMENT_NAME: tke-test

permissions:
  contents: read

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production
    steps:

    - name: Checkout
      uses: actions/checkout@v3
      
    # Build
    - name: Build Docker image
      run: |        
        docker build -t ${TKE_IMAGE_URL}:${GITHUB_SHA} .

    - name: Login TKE Registry
      run: |
        docker login -u ${{ secrets.TENCENT_CLOUD_ACCOUNT_ID }} -p '${{ secrets.TKE_REGISTRY_PASSWORD }}' ${TKE_IMAGE_URL}

    # Push the Docker image to TKE Registry
    - name: Publish
      run: |
        docker push ${TKE_IMAGE_URL}:${GITHUB_SHA}

    - name: Set up Kustomize
      run: |
        curl -o kustomize --location https://github.com/kubernetes-sigs/kustomize/releases/download/v3.1.0/kustomize_3.1.0_linux_amd64
        chmod u+x ./kustomize

    - name: Set up ~/.kube/config for connecting TKE cluster
      uses: TencentCloud/tke-cluster-credential-action@v1
      with:
        secret_id: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
        secret_key: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
        tke_region: ${{ env.TKE_REGION }}
        cluster_id: ${{ env.TKE_CLUSTER_ID }}
    
    - name: Switch to TKE context
      run: |
        kubectl config use-context ${TKE_CLUSTER_ID}-context-default

    # Deploy the Docker image to the TKE cluster
    - name: Deploy
      run: |
        ./kustomize edit set image ${TKE_IMAGE_URL}:${GITHUB_SHA}
        ./kustomize build . | kubectl apply -f -
        kubectl rollout status deployment/${DEPLOYMENT_NAME}
        kubectl get services -o wide
